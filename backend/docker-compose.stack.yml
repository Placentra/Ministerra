networks:
    ministerra-net:
        driver: overlay
        attachable: true

volumes:
    redis-primary-data:
    redis-replica1-data:
    redis-sentinel1-data:
    redis-sentinel2-data:
    redis-sentinel3-data:
    mysql-data:
        name: backend_mysql-data
    mysql-replica-data:
    prometheus-data:
    grafana-data:
    loki-data:
    tempo-data:
    alertmanager-data:
    traefik-letsencrypt:

services:
    # ============================================================================
    # TRAEFIK (Reverse Proxy & Load Balancer)
    # ============================================================================
    traefik:
        image: traefik:v3.0
        command:
            - '--providers.docker=true'
            - '--providers.docker.exposedbydefault=false'
            - '--providers.docker.swarmmode=true' # ENABLE SWARM MODE
            - '--entrypoints.web.address=:80'
            - '--entrypoints.websecure.address=:443'
            - '--entrypoints.web.http.redirections.entryPoint.to=websecure'
            - '--entrypoints.web.http.redirections.entryPoint.scheme=https'
            - '--certificatesresolvers.myresolver.acme.tlschallenge=true'
            - '--certificatesresolvers.myresolver.acme.email=${ACME_EMAIL}'
            - '--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json'
            - '--metrics.prometheus=true'
            - '--metrics.prometheus.addEntryPointsLabels=true'
            - '--metrics.prometheus.addrouterslabels=true'
            - '--api.dashboard=true'
        ports:
            - '${TRAEFIK_HTTP_PORT:-80}:80'
            - '${TRAEFIK_HTTPS_PORT:-443}:443'
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - traefik-letsencrypt:/letsencrypt
        networks:
            - ministerra-net
        deploy:
            mode: global # Run on every node (if you add more nodes later)
            placement:
                constraints:
                    - node.role == manager
            update_config:
                parallelism: 1
                delay: 10s

    # ============================================================================
    # BACKEND WEB (Scalable HTTP + Socket.IO)
    # ============================================================================
    backend-web:
        image: ministerra-backend:latest
        environment:
            - NODE_ENV=production
            - SWARM_MODE=true
            - MIN_MODE=false
            - WORKER_ID={{.Task.Slot}}
            - TZ=UTC
            - BE_PORT=2208
            - SOCKET_PORT=2209
            - MONITORING_PORT=9464
            - MONITORING_TOKEN=${MONITORING_TOKEN}
            - OTEL_SERVICE_NAME=backend-web
            - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
            - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
            - REDIS_USE_SENTINEL=true
            - REDIS_SENTINEL_NAME=mymaster
            - REDIS_SENTINELS=redis-sentinel1:26379,redis-sentinel2:26379,redis-sentinel3:26379
            - REDIS_PASSWORD=${REDIS_PASSWORD}
            - REDIS_SENTINEL_PASSWORD=${REDIS_PASSWORD}
            - HOST=${DB_HOST:-mysql}
            - DB_PORT=3306
            - DB_USER=${DB_USER}
            - DB_PASS=${DB_PASS}
            - DB_NAME=${DB_NAME}
            - DB_READ_HOST=${DB_READ_HOST:-mysql-replica}
            - DB_READ_PORT=3306
            - DB_READ_SPLIT=1
        healthcheck:
            test: ['CMD-SHELL', 'curl -fsS http://localhost:2208/metrics || exit 1']
            interval: 30s
            timeout: 5s
            retries: 5
        networks:
            - ministerra-net
        deploy:
            mode: replicated
            replicas: 2
            restart_policy:
                condition: on-failure
                delay: 5s
                max_attempts: 3
            update_config:
                order: start-first
                failure_action: rollback
                delay: 10s
            labels:
                - 'traefik.enable=true'
                # 1. HTTP ROUTER
                - 'traefik.http.routers.backend.rule=Host(`${APP_HOST}`) && (PathPrefix(`/entrance`) || PathPrefix(`/foundation`) || PathPrefix(`/event`) || PathPrefix(`/gallery`) || PathPrefix(`/user`) || PathPrefix(`/content`) || PathPrefix(`/discussion`) || PathPrefix(`/report`) || PathPrefix(`/editor`) || PathPrefix(`/setup`) || PathPrefix(`/interests`) || PathPrefix(`/locations`) || PathPrefix(`/rating`) || PathPrefix(`/search`) || PathPrefix(`/chat`) || PathPrefix(`/alerts`) || PathPrefix(`/invites`) || PathPrefix(`/devices`) || PathPrefix(`/public`) || PathPrefix(`/metrics`) || PathPrefix(`/admin`))'
                - 'traefik.http.routers.backend.entrypoints=websecure'
                - 'traefik.http.routers.backend.tls.certresolver=myresolver'
                - 'traefik.http.routers.backend.service=backend'
                # Load Balancer & Port
                - 'traefik.http.services.backend.loadbalancer.server.port=2208'

                # 2. SOCKET.IO ROUTER (Sticky Sessions!)
                - 'traefik.http.routers.socket.rule=Host(`${APP_HOST}`) && PathPrefix(`/socket.io`)'
                - 'traefik.http.routers.socket.entrypoints=websecure'
                - 'traefik.http.routers.socket.tls.certresolver=myresolver'
                - 'traefik.http.routers.socket.service=socket'
                - 'traefik.http.services.socket.loadbalancer.server.port=2209'

                # STICKY SESSIONS CONFIGURATION
                - 'traefik.http.services.socket.loadbalancer.sticky.cookie=true'
                - 'traefik.http.services.socket.loadbalancer.sticky.cookie.name=srv_id'
                - 'traefik.http.services.socket.loadbalancer.sticky.cookie.secure=true'
                - 'traefik.http.services.socket.loadbalancer.sticky.cookie.httpOnly=true'

    # ============================================================================
    # BACKEND TASKS (Singleton - Background Jobs)
    # ============================================================================
    backend-tasks:
        image: ministerra-backend:latest
        environment:
            - NODE_ENV=production
            - SWARM_MODE=true
            - MIN_MODE=true
            - CONFIG_FORCE_TASK_WORKER=true
            - WORKER_ID=1
            - TZ=UTC
            - BE_PORT=2208
            - REDIS_USE_SENTINEL=true
            - REDIS_SENTINEL_NAME=mymaster
            - REDIS_SENTINELS=redis-sentinel1:26379,redis-sentinel2:26379,redis-sentinel3:26379
            - REDIS_PASSWORD=${REDIS_PASSWORD}
            - REDIS_SENTINEL_PASSWORD=${REDIS_PASSWORD}
            - HOST=${DB_HOST:-mysql}
            - DB_PORT=3306
            - DB_USER=${DB_USER}
            - DB_PASS=${DB_PASS}
            - DB_NAME=${DB_NAME}
        healthcheck:
            test: ['CMD-SHELL', 'curl -fsS http://localhost:2208/metrics || exit 1']
            interval: 30s
            timeout: 5s
            retries: 5
        networks:
            - ministerra-net
        deploy:
            mode: replicated
            replicas: 1
            restart_policy:
                condition: on-failure
                delay: 5s
                max_attempts: 3
            placement:
                constraints:
                    - node.role == manager
            labels:
                - 'traefik.enable=false'

    # ============================================================================
    # FRONTEND
    # ============================================================================
    frontend:
        image: ministerra-frontend:latest
        environment:
            - NODE_ENV=production
        healthcheck:
            test: ['CMD-SHELL', 'curl -fsS http://localhost:80/ || exit 1']
            interval: 30s
            timeout: 5s
            retries: 3
        networks:
            - ministerra-net
        deploy:
            mode: replicated
            replicas: 1
            restart_policy:
                condition: on-failure
                delay: 5s
            labels:
                - 'traefik.enable=true'
                - 'traefik.http.routers.frontend.rule=Host(`${APP_HOST}`)'
                - 'traefik.http.routers.frontend.entrypoints=websecure'
                - 'traefik.http.routers.frontend.tls.certresolver=myresolver'
                - 'traefik.http.routers.frontend.priority=1'
                - 'traefik.http.services.frontend.loadbalancer.server.port=80'

    # ============================================================================
    # INFRASTRUCTURE (Redis, MySQL, Monitoring)
    # ============================================================================
    redis-primary:
        image: redis:7.4.7
        command: sh -c "cp /usr/local/etc/redis/master.conf /data/master.conf && exec redis-server /data/master.conf --requirepass $${REDIS_PASSWORD}"
        environment:
            - REDIS_PASSWORD=${REDIS_PASSWORD}
        volumes:
            - redis-primary-data:/data
            - ./systems/redis:/usr/local/etc/redis:ro
        healthcheck:
            test: ['CMD-SHELL', 'redis-cli -a "$${REDIS_PASSWORD}" ping | grep PONG']
            interval: 10s
            timeout: 3s
            retries: 5
        networks:
            - ministerra-net
        deploy:
            restart_policy:
                condition: on-failure
            placement:
                constraints: [node.role == manager]

    redis-replica1:
        image: redis:7.4.7
        command: sh -c "cp /usr/local/etc/redis/slave.conf /data/slave.conf && exec redis-server /data/slave.conf --requirepass $${REDIS_PASSWORD} --masterauth $${REDIS_PASSWORD}"
        environment:
            - REDIS_PASSWORD=${REDIS_PASSWORD}
        volumes:
            - redis-replica1-data:/data
            - ./systems/redis:/usr/local/etc/redis:ro
        healthcheck:
            test: ['CMD-SHELL', 'redis-cli -a "$${REDIS_PASSWORD}" ping | grep PONG']
            interval: 10s
            timeout: 3s
            retries: 5
        networks:
            - ministerra-net
        deploy:
            restart_policy:
                condition: on-failure

    redis-sentinel1:
        image: redis:7.4.7
        command: sh -c "cp /usr/local/etc/redis/sentinel1.conf /data/sentinel.conf && sed \"s/\\$\\{REDIS_PASSWORD\\}/$${REDIS_PASSWORD}/g\" /data/sentinel.conf > /data/sentinel.rendered.conf && exec redis-sentinel /data/sentinel.rendered.conf"
        environment:
            - REDIS_PASSWORD=${REDIS_PASSWORD}
        volumes:
            - ./systems/redis:/usr/local/etc/redis:ro
            - redis-sentinel1-data:/data
        healthcheck:
            test: ['CMD-SHELL', 'redis-cli -p 26379 -a "$${REDIS_PASSWORD}" ping | grep PONG']
            interval: 10s
            timeout: 3s
            retries: 5
        networks:
            - ministerra-net
        deploy:
            restart_policy:
                condition: on-failure

    redis-sentinel2:
        image: redis:7.4.7
        command: sh -c "cp /usr/local/etc/redis/sentinel2.conf /data/sentinel.conf && sed \"s/\\$\\{REDIS_PASSWORD\\}/$${REDIS_PASSWORD}/g\" /data/sentinel.conf > /data/sentinel.rendered.conf && exec redis-sentinel /data/sentinel.rendered.conf"
        environment:
            - REDIS_PASSWORD=${REDIS_PASSWORD}
        volumes:
            - ./systems/redis:/usr/local/etc/redis:ro
            - redis-sentinel2-data:/data
        healthcheck:
            test: ['CMD-SHELL', 'redis-cli -p 26379 -a "$${REDIS_PASSWORD}" ping | grep PONG']
            interval: 10s
            timeout: 3s
            retries: 5
        networks:
            - ministerra-net
        deploy:
            restart_policy:
                condition: on-failure

    redis-sentinel3:
        image: redis:7.4.7
        command: sh -c "cp /usr/local/etc/redis/sentinel3.conf /data/sentinel.conf && sed \"s/\\$\\{REDIS_PASSWORD\\}/$${REDIS_PASSWORD}/g\" /data/sentinel.conf > /data/sentinel.rendered.conf && exec redis-sentinel /data/sentinel.rendered.conf"
        environment:
            - REDIS_PASSWORD=${REDIS_PASSWORD}
        volumes:
            - ./systems/redis:/usr/local/etc/redis:ro
            - redis-sentinel3-data:/data
        healthcheck:
            test: ['CMD-SHELL', 'redis-cli -p 26379 -a "$${REDIS_PASSWORD}" ping | grep PONG']
            interval: 10s
            timeout: 3s
            retries: 5
        networks:
            - ministerra-net
        deploy:
            restart_policy:
                condition: on-failure

    # MYSQL ---
    mysql:
        image: mysql:8.0
        command:
            - --server-id=1
            - --log-bin=mysql-bin
            - --binlog-format=ROW
            - --gtid-mode=ON
            - --enforce-gtid-consistency=ON
            - --sync-binlog=1
            - --binlog-checksum=CRC32
        environment:
            - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
            - MYSQL_ROOT_HOST=%
            - MYSQL_DATABASE=${DB_NAME}
            - MYSQL_USER=${DB_USER}
            - MYSQL_PASSWORD=${DB_PASS}
        volumes:
            - mysql-data:/var/lib/mysql
        healthcheck:
            test: ['CMD-SHELL', 'mysqladmin ping -h 127.0.0.1 -p$$MYSQL_ROOT_PASSWORD || exit 1']
            interval: 10s
            timeout: 10s
            retries: 30
            start_period: 60s
        networks:
            - ministerra-net
        deploy:
            restart_policy:
                condition: on-failure
            placement:
                constraints: [node.role == manager]

    mysql-replica:
        image: mysql:8.0
        command:
            - --server-id=2
            - --read-only=1
            - --relay-log=relay-bin
            - --log-bin=mysql-bin
            - --binlog-format=ROW
            - --gtid-mode=ON
            - --enforce-gtid-consistency=ON
            - --binlog-checksum=CRC32
            - --log-slave-updates=ON
        environment:
            - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
        volumes:
            - mysql-replica-data:/var/lib/mysql
        healthcheck:
            test: ['CMD-SHELL', 'mysqladmin ping -h 127.0.0.1 -p$$MYSQL_ROOT_PASSWORD || exit 1']
            interval: 10s
            timeout: 10s
            retries: 30
            start_period: 60s
        networks:
            - ministerra-net
        deploy:
            restart_policy:
                condition: on-failure

    # MONITORING ---
    prometheus:
        image: prom/prometheus:v2.55.1
        command:
            - --config.file=/etc/prometheus/prometheus.yml
            - --storage.tsdb.retention.time=15d
        volumes:
            - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - ./monitoring/prometheus/alerts:/etc/prometheus/alerts:ro
            - ./monitoring/prometheus/secrets:/etc/prometheus/secrets:ro
            - prometheus-data:/prometheus
        healthcheck:
            test: ['CMD-SHELL', 'wget -qO- http://localhost:9090/-/healthy || exit 1']
            interval: 30s
            timeout: 5s
            retries: 3
        networks:
            - ministerra-net
        deploy:
            mode: replicated
            replicas: 1
            restart_policy:
                condition: on-failure

    grafana:
        image: grafana/grafana:10.4.0
        environment:
            - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
            - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
            - GF_AUTH_ANONYMOUS_ENABLED=false
        volumes:
            - grafana-data:/var/lib/grafana
            - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
        healthcheck:
            test: ['CMD-SHELL', 'curl -fsS http://localhost:3000/api/health || exit 1']
            interval: 30s
            timeout: 5s
            retries: 3
        networks:
            - ministerra-net
        deploy:
            mode: replicated
            replicas: 1
            restart_policy:
                condition: on-failure
        ports:
            - '3000:3000'

    otel-collector:
        image: otel/opentelemetry-collector-contrib:0.98.0
        command: ['--config=/etc/otelcol/config.yaml']
        volumes:
            - ./monitoring/otel-collector/otel-collector-config.yaml:/etc/otelcol/config.yaml:ro
        healthcheck:
            test: ['CMD-SHELL', 'wget -qO- http://localhost:13133/ || exit 1']
            interval: 30s
            timeout: 5s
            retries: 3
        networks:
            - ministerra-net
        deploy:
            mode: replicated
            replicas: 1
            restart_policy:
                condition: on-failure
